





在django后台配置客户库的url为`/useradmin/crm/customerinfo/`

显示高亮

useradmin/templates/useradmin/index.html

```html
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 col-md-2 sidebar">
                <ul class="nav nav-sidebar">

                    {% for role in request.user.userprofile.role.all %}
                        {% for menu in role.menus.all %}
                            {% if request.path == menu.url_name %}
                                <li class="active"><a href="{% if menu.url_type == 0 %}{{ menu.url_name }}{% else %}{% url menu.url_name %}{% endif %}">{{ menu.name }}</a></li>
                            {% else %}
                                 <li><a href="{% if menu.url_type == 0 %}{{ menu.url_name }}{% else %}{% url menu.url_name %}{% endif %}">{{ menu.name }}</a></li>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                    {# {{ request.user.userprofile.role.select_related }}  同样的效果#}
                </ul>
            </div>
            <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
                {% block right-content-container %}

                {% endblock right-content-container %}
            </div>
        </div>
    </div>
{% endblock body %}
```

## 1、流程

销售：选择班级，发报名链接给学员

​	    选择客户，生成报名链接

学员：填写报名表，提交个人信息，上传证件信息，同意学习协议

销售：选择报名表，审核通过后，创建一条缴费记录，把学员添加到相应的班级，报名成功，状态自动改为成功

## 2、实现

#### ①添加三张表

crm/models.py



```python
...
class Student(models.Model):
    """学员表"""
    customer = models.OneToOneField("CustomerInfo", on_delete=models.CASCADE)
    class_grades = models.ManyToManyField("ClassList")

    def __str__(self):
        return self.customer.name
...
class ClassList(models.Model):
...
    contract_template = models.ForeignKey('ContractTemplate', blank=True, null=True, on_delete=models.CASCADE)
...

...
class ContractTemplate(models.Model):
    """协议模板"""
    name = models.CharField(max_length=64)
    content = models.TextField()

    date = models.DateField(auto_now_add=True)


class StudentEnrollment(models.Model):
    """学员报名表"""
    customer = models.ForeignKey('CustomerInfo', on_delete=models.CASCADE)
    class_grade = models.ForeignKey('ClassList',on_delete=models.CASCADE)
    consulant = models.ForeignKey('UserProfile', on_delete=models.CASCADE)
    contract_agreed = models.BooleanField(default=False)
    contract_signed_date = models.DateTimeField(blank=True,null=True)
    contract_approved = models.BooleanField(default=False)
    contract_approved_date = models.DateTimeField(verbose_name='审核时间',blank=True,null=True)
    
    class Meta:
        unique_together = ('customer','class_grade')
        
    def __str__(self):
        return "%s" %self.customer


class PaymentRecord(models.Model):
    """存储学员缴费记录"""
    enrollment = models.ForeignKey('StudentEnrollment',on_delete=models.CASCADE)
    payment_type_choices = ((0,'报名费'),(1,'学费'),(2,'退费'))
    payment_type = models.SmallIntegerField(choices=payment_type_choices,default=0)
    amount = models.IntegerField('费用',default=500)
    consultant = models.ForeignKey('UserProfile',on_delete=models.CASCADE)
    date = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return '%s' %self.enrollment

```

#### ②配置显示页面

crm/views.py

```python
@login_required
def stu_enrollment(request):
    customers = models.CustomerInfo.objects.all()
    class_lists = models.ClassList.objects.all()
    if request.method == 'POST':
        customer_id = request.POST.get('customer_id')
        class_grade_id = request.POST.get('class_grade_id')
        enrollment_obj = models.StudentEnrollment.objects.create(
            customer_id=customer_id,
            class_grade_id=class_grade_id,
            consulant_id=request.user.userprofile.id
        )

        enrollment_link = 'http://localhost:8000/crm/enrollment/%s/'%enrollment_obj.id

    return render(request, 'crm/stu_enrollment.html',locals())
```

crm/urls.py

```python
    path('stu_enrollment', views.stu_enrollment, name='stu_enrollment'),
```

templates/crm/index.html

```html
...
            <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
                {% block right-content-containter %}
                <h2 class="page-header">Dashboard</h2>
                {% endblock right-content-containter %}
            </div>
        </div>
    </div>
{% endblock body %}
```

templates/crm/stu_enrollment.html

```html
{% extends 'index.html' %}

{% block right-content-containter %}
    <h3>学员报名</h3>
    <form class="form-horizontal" method="post">{% csrf_token %}
        <div class="form-group">
            <label class="col-sm-2 control-label">客户</label>
            <div class="col-sm-8">
                <select name="customer_id" class="form-control">
                    {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="inputPassword3" class="col-sm-2 control-label">报名班级</label>
            <div class="col-sm-8">
                <select name="class_grade_id" class="form-control">
                    {% for class_grade in class_lists %}
                        <option value="{{ class_grade.id }}">{{ class_grade }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-sm-offset-9 col-sm-2">
            <input type="submit" class="btn btn-success pull-right" value="下一步">
        </div>

    </form>
    <br>
    <br>
    {% if enrollment_link %}

        <p>请将报名链接复制并发送给学员填写{{ enrollment_link }}</p>
    {% endif %}
{% endblock right-content-containter %}
```

#### ③配置用户注册页面

###### 1）为用户表添加字段

crm/models.py

```python
class CustomerInfo(models.Model):
    """客户信息表"""
    name = models.CharField(max_length=64, default=None)
    contact_type_choices = ((0, 'qq'), (1, '微信'), (2, '手机'))
    contact_type = models.SmallIntegerField(choices=contact_type_choices, default=0)  # SmallIntegerField 0-65535 16位
    contact = models.CharField(max_length=64, unique=True)
    source_choices = ((0, 'QQ群'),
                      (1, '51'),
                      (2, '百度推广'),
                      (3, '知乎'),
                      (4, '转介绍'),
                      (5, '其它'),
                      )
    source = models.SmallIntegerField(choices=source_choices)
    referral_from = models.ForeignKey("self", blank=True, null=True, verbose_name="转介绍", on_delete=models.CASCADE)
    consult_courses = models.ManyToManyField("Course", verbose_name="咨询课程")
    consult_content = models.TextField(verbose_name="咨询内容")
    status_choices = ((0, '未报名'), (1, '已报名'), (2, '已退学'))
    status = models.SmallIntegerField(choices=status_choices)
    consultant = models.ForeignKey("UserProfile", verbose_name="课程顾问", on_delete=models.CASCADE)
    id_num = models.CharField(max_length=128,blank=True,null=True)
    emergency_contact = models.PositiveIntegerField(blank=True,null=True)
    sex_choices = ((0,'男'),(1,'女'))
    sex = models.PositiveIntegerField(choices=sex_choices,blank=True,null=True)
    

    date = models.DateField(auto_now_add=True)

    def __str__(self):
        return self.name

```

crm/views.py

```python
def enrollment(request,enrollment_id):
    """学员在线报名表地址"""
    enrollment_obj = models.StudentEnrollment.objects.get(id=enrollment_id)
    customer_form = forms.CustomerForm(instance=enrollment_obj.customer)

    return render(request,'crm/enrollment.html',locals())
```

新建templates/crm/enrollment.html

```html
{% extends 'index.html' %}

{% block body %}
    <div class="container">
        <h3>xxxxx</h3>
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">学员在线报名</h3>
            </div>
            <div class="panel-body">
                <form class="form" method="post" onsubmit="return BrforeFormSubmit()">
                    {% csrf_token %}


                {% for field in customer_form %}
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">{{ field.label }}</label>
                        <div class="col-sm-10">
                            {{ field }}
                        </div>
                    </div>
                {% endfor %}
                <div class="form-group col-lg-6">
                    <label class="col-sm-2 control-label">报名班级</label>
                    <div class="col-sm-10">
                        {{ enrollment_obj.class_grade }}
                    </div>
                </div>
                <div class="form-group col-lg-6">
                    <label class="col-sm-2 control-label">学费</label>
                    <div class="col-sm-10">
                        {{ enrollment_obj.class_grade.course.price }}
                    </div>
                </div>
                    <input type="submit" class="btn btn-success" value="提交">
                </form>

            </div>
            <div class="panel-footer">Panel footer</div>
        </div>

    </div>
    <script>
    function BrforeFormSubmit(ele) {
        $(":disabled").removeAttr('disabled');
        //return false
    }

    </script>

{% endblock body %}
```

forms.py

```python

from django.forms import ModelForm
from crm import models


class CustomerForm(ModelForm):
    def __new__(cls, *args, **kwargs):
        # print('__new__', cls, args, kwargs)
        # print(cls.base_fields)
        for field_name in cls.base_fields:
            field_obj = cls.base_fields[field_name]
            field_obj.widget.attrs.update({'class': 'form-control'})


            if field_name in cls.Meta.readonly_fields:
                field_obj.widget.attrs.update({'disabled': 'true'})

        return ModelForm.__new__(cls)

    class Meta:  # 关联表
        model = models.CustomerInfo
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段
        exclude = ['consult_content','status','consult_courses']
        readonly_fields = ['contact_type','contact','consultant','referral_from','consult_courses','source']
```

###### 2）配置后台

views.py

```python
def enrollment(request,enrollment_id):
    """学员在线报名表地址"""
    enrollment_obj = models.StudentEnrollment.objects.get(id=enrollment_id)
    if request.method == 'POST':
        # print('enrollment:' ,request.POST)
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer,data=request.POST)
        if customer_form.is_valid():
            customer_form.save()
            return HttpResponse('您已成功提交报名信息，请等待审核')
        # print('form err',customer_form.errors)
    else:
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer)

    return render(request,'crm/enrollment.html',locals())
```

###### 3）修改BUG

关于用户自己修改disabled样式

与数据库比对

views.py

```python
def enrollment(request,enrollment_id):
    """学员在线报名表地址"""
    enrollment_obj = models.StudentEnrollment.objects.get(id=enrollment_id)
    if request.method == 'POST':
        # print('enrollment:' ,request.POST)
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer,data=request.POST)
        if customer_form.is_valid():
            # print(customer_form.cleaned_data)
            customer_form.save()
            return HttpResponse('您已成功提交报名信息，请等待审核')
        # print('form err',customer_form.errors)
    else:
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer)

    return render(request,'crm/enrollment.html',locals())
```

forms.py

```python
from django.forms import ModelForm
from django import forms
from crm import models


class CustomerForm(ModelForm):
    def __new__(cls, *args, **kwargs):
        # print('__new__', cls, args, kwargs)
        # print(cls.base_fields)
        for field_name in cls.base_fields:
            field_obj = cls.base_fields[field_name]
            field_obj.widget.attrs.update({'class': 'form-control'})

            if field_name in cls.Meta.readonly_fields:
                field_obj.widget.attrs.update({'disabled': 'true'})

        return ModelForm.__new__(cls)

    class Meta:  # 关联表
        model = models.CustomerInfo
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段
        exclude = ['consult_content', 'status', 'consult_courses']
        readonly_fields = ['contact_type', 'contact', 'consultant', 'referral_from', 'source']

    def clean(self): # form 保存之前会调用
        if self.errors:
            raise forms.ValidationError(("Please fix errors before re-submit."))
        if self.instance.id is not None:  # means this is a change form ,should check the readonly fields
            for field in self.Meta.readonly_fields:
                old_field_val = getattr(self.instance, field)  # 数据库里的数据
                form_val = self.cleaned_data.get(field)
                print("filed differ compare:", old_field_val, form_val)
                if old_field_val != form_val:
                    # 字段错误
                    self.add_error(field, "Readonly Field: field should be '{value}' ,not '{new_value}' ". \
                                   format(**{'value': old_field_val, 'new_value': form_val}))


```



###### 4）添加协议、图片等

协议

在crm/admin.py注册

```python
admin.site.register(PaymentRecord)
admin.site.register(ContractTemplate)
admin.site.register(StudentEnrollment)
```

enrollment.html

```html
{% extends 'index.html' %}

{% block body %}
    <div class="container">
        <h3>xxxxx</h3>
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">学员在线报名</h3>
            </div>
            <div class="panel-body">
                <form class="form" method="post" onsubmit="return BrforeFormSubmit()">
                    {% csrf_token %}

                    {% for field in customer_form %}
                        <div class="form-group col-lg-6">
                            <label class="col-sm-2 control-label">{{ field.label }}</label>
                            <div class="col-sm-10">
                                {{ field }}
                                <span style="color: red;">{{ field.errors.0 }}</span>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">报名班级</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade }}
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">学费</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade.course.price }}
                        </div>
                    </div>

                    <hr>
                    <pre style="height: 400px">{{ enrollment_obj.class_grade.contract_template.content }}</pre>

                    <input type="checkbox" name="contract_agreed" >我已认真阅读、并同意
                
                    <input type="submit" class="btn btn-success" value="提交">
                </form>

            </div>
            <div class="panel-footer">Panel footer</div>
        </div>

    </div>
    <script>
        function BrforeFormSubmit(ele) {
            $(":disabled").removeAttr('disabled');
            //return false
        }

    </script>

{% endblock body %}
```

图片，此时需要一个插件，文件直接拷贝static/plugins/dropzone

base.html

```
{% block extra-js %}
{% endblock extra-js %}
```

enrollment.html

```html
{% extends 'index.html' %}
{% load staticfiles %}
{% block extra-css %}
    <link rel="stylesheet" href="{% static 'plugins/dropzone/dropzone.css' %}  ">
{% endblock extra-css %}
{% block body %}
    <div class="container">
        <h3>xxxxx</h3>
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">学员在线报名</h3>
            </div>
            <div class="panel-body">
                <form class="form" method="post" onsubmit="return BrforeFormSubmit()">
                    {% csrf_token %}

                    {% for field in customer_form %}
                        <div class="form-group col-lg-6">
                            <label class="col-sm-2 control-label">{{ field.label }}</label>
                            <div class="col-sm-10">
                                {{ field }}
                                <span style="color: red;">{{ field.errors.0 }}</span>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">报名班级</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade }}
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">学费</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade.course.price }}
                        </div>
                    </div>

                    <hr>
                    <pre style="height: 400px">{{ enrollment_obj.class_grade.contract_template.content }}</pre>

                    <input type="checkbox" name="contract_agreed" >我已认真阅读、并同意
                
                    <input type="submit" class="btn btn-success" value="提交">
                </form>

                <form action="{% url 'enrollment_fileupload' enrollment_obj.id %}" class="dropzone">
                    <div class="fallback">
                        <input name="file" type="file" multiple>
                    </div>
                </form>


            </div>
            <div class="panel-footer">Panel footer</div>
        </div>

    </div>
    <script>
        function BrforeFormSubmit(ele) {
            $(":disabled").removeAttr('disabled');
            //return false
        }

    </script>

{% endblock body %}
{% block extra-js %}
    <script src="{% static 'plugins/dropzone/dropzone.js' %}"></script>
{% endblock extra-js %}
```

crm/views.py

```python
...
from django import conf
from django.views.decorators.csrf import csrf_exempt
...
def enrollment(request,enrollment_id):
    """学员在线报名表地址"""
    enrollment_obj = models.StudentEnrollment.objects.get(id=enrollment_id)
    if request.method == 'POST':
        # print('enrollment:' ,request.POST)
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer,data=request.POST)
        if customer_form.is_valid():
            # print(customer_form.cleaned_data)
            customer_form.save()
            return HttpResponse('您已成功提交报名信息，请等待审核')
        # print('form err',customer_form.errors)
    else:
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer)
    # 列出已上传的文件
    uploaded_files = []
    enrollment_upload_dir = os.path.join(conf.settings.CRM_FILE_UPLOAD_DIR,enrollment_id)
    if os.path.isdir(enrollment_upload_dir):
        uploaded_files = os.listdir(enrollment_upload_dir)

    return render(request,'crm/enrollment.html',locals())


@csrf_exempt
def enrollment_fileupload(request,enrollment_id):
    # print(request.FILES)
    # print(conf.settings.CRM_FILE_UPLOAD_DIR)

    enrollment_upload_dir = os.path.join(conf.settings.CRM_FILE_UPLOAD_DIR,enrollment_id)
    if not os.path.isdir(enrollment_upload_dir):
        os.mkdir(enrollment_upload_dir)

    file_obj = request.FILES.get('file')

    with open(os.path.join(enrollment_upload_dir,file_obj.name),'wb') as f:
        for chunks in file_obj.chunks():
            f.write(chunks)

    return HttpResponse('qwe')
```

settings.py

```python
CRM_FILE_UPLOAD_DIR = os.path.join(BASE_DIR,'crm/upload_files/enrollment_data')
```

crm/urls.py

```python
from django.urls import path
from . import views

urlpatterns = [
    path('', views.dashboard, name='sales_dashboard'),
    path('stu_enrollment', views.stu_enrollment, name='stu_enrollment'),
    path('enrollment/<str:enrollment_id>/',views.enrollment,name='enrollment'),
    path('enrollment/<str:enrollment_id>/fileupload/',views.enrollment_fileupload,name='enrollment_fileupload'),
]
```

控制文件上传数量和总数量

crm/views.py

```python
@csrf_exempt
def enrollment_fileupload(request,enrollment_id):
    # print(request.FILES)
    # print(conf.settings.CRM_FILE_UPLOAD_DIR)

    enrollment_upload_dir = os.path.join(conf.settings.CRM_FILE_UPLOAD_DIR,enrollment_id)
    if not os.path.isdir(enrollment_upload_dir):
        os.mkdir(enrollment_upload_dir)

    file_obj = request.FILES.get('file')

    if len(os.listdir(enrollment_upload_dir)) <= 2:

        with open(os.path.join(enrollment_upload_dir,file_obj.name),'wb') as f:
            for chunks in file_obj.chunks():
                f.write(chunks)
    else:
        return HttpResponse(json.dumps({'status':False,'err_msg':'max upload limit is 2'}))

    return HttpResponse(json.dumps({'status': True}))
```

enrollment.html

```html
{% extends 'index.html' %}
{% load staticfiles %}
{% block extra-css %}
    <link rel="stylesheet" href="{% static 'plugins/dropzone/dropzone.css' %}  ">
{% endblock extra-css %}
{% block body %}
    <div class="container">
        <h3>xxxxx</h3>
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">学员在线报名</h3>
            </div>
            <div class="panel-body">
                <form class="form" method="post" onsubmit="return BrforeFormSubmit()">
                    {% csrf_token %}

                    {% for field in customer_form %}
                        <div class="form-group col-lg-6">
                            <label class="col-sm-2 control-label">{{ field.label }}</label>
                            <div class="col-sm-10">
                                {{ field }}
                                <span style="color: red;">{{ field.errors.0 }}</span>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">报名班级</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade }}
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">学费</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade.course.price }}
                        </div>
                    </div>

                    <hr>
                    <pre style="height: 400px">{{ enrollment_obj.class_grade.contract_template.content }}</pre>

                    <input type="checkbox" name="contract_agreed" >我已认真阅读、并同意
                
                    <input type="submit" class="btn btn-success" value="提交">
                </form>

                {% if uploaded_files %}
                <p>以上传文件列表</p>
                <ul id="uploaded_files">
                    {% for file in uploaded_files %}
                    <li>{{ file }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

                <form id="myAwesomeDropzone" action="{% url 'enrollment_fileupload' enrollment_obj.id %}" class="dropzone">
                    <div class="fallback">
                        <input  name="file" type="file" multiple>
                    </div>
                </form>


            </div>
            <div class="panel-footer">Panel footer</div>
        </div>

    </div>
    <script>
        function BrforeFormSubmit(ele) {
            $(":disabled").removeAttr('disabled');
            //return false
        }

    </script>

{% endblock body %}
{% block extra-js %}
    <script src="{% static 'plugins/dropzone/dropzone.js' %}"></script>
 <script>

        // "myAwesomeDropzone" is the camelized version of the HTML element's ID
        Dropzone.options.myAwesomeDropzone = {
          paramName: "file", // The name that will be used to transfer the file
          maxFilesize: 2, // 文件最大是2MB
          maxFiles:2,      //最大上传文件数
          parallelUploads:1, // 并发数目
          accept: function(file, done) {
            if (file.name === "justinbieber.jpg") {
              done("Naha, you don't.");
            }
            else { done(); }
          }
        };

        $(function() {
          // Now that the DOM is fully loaded, create the dropzone, and setup the
          // event listeners
          // Prevent Dropzone from auto discovering this element:
          Dropzone.options.myAwesomeDropzone = false;
          var myDropzone = new Dropzone("#myAwesomeDropzone");
          myDropzone.on("success", function(file,response) {
            /* Maybe display some more file information on your page */
             console.log("completet", file, response);
             var response = JSON.parse(response);
             if (!response.status){
                 alert(response.err_msg);
             }else {
                 $("#uploaded_files").append("<li>"+ file.name +"</li>");

             }

          });
        })

    </script>

{% endblock extra-js %}
```

提交

enrollment.html

```html
{% extends 'index.html' %}
{% load staticfiles %}
{% block extra-css %}
    <link rel="stylesheet" href="{% static 'plugins/dropzone/dropzone.css' %}  ">
{% endblock extra-css %}
{% block body %}
    <div class="container">
        <h3>xxxxx</h3>
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">学员在线报名</h3>
            </div>
            <div class="panel-body">
                <form class="form" method="post" onsubmit="return BeforeFormSubmit(this)">
                    {% csrf_token %}

                    {% for field in customer_form %}
                        <div class="form-group col-lg-6">
                            <label class="col-sm-2 control-label">{{ field.label }}</label>
                            <div class="col-sm-10">
                                {{ field }}
                                <span style="color: red;">{{ field.errors.0 }}</span>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">报名班级</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade }}
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label class="col-sm-2 control-label">学费</label>
                        <div class="col-sm-10">
                            {{ enrollment_obj.class_grade.course.price }}
                        </div>
                    </div>

                    <hr>
                    <pre style="height: 400px">{{ enrollment_obj.class_grade.contract_template.content }}</pre>

                    <input type="checkbox" name="contract_agreed" >我已认真阅读、并同意

                    <input type="submit" class="btn btn-success" value="提交">
                </form>


                <p>以上传文件列表</p>
                <ul id="uploaded_files">
                    {% for file in uploaded_files %}
                    <li>{{ file }}</li>
                    {% endfor %}
                </ul>


                <form id="myAwesomeDropzone" action="{% url 'enrollment_fileupload' enrollment_obj.id %}" class="dropzone">
                    <div class="fallback">
                        <input  name="file" type="file" multiple>
                    </div>
                </form>


            </div>
            <div class="panel-footer">Panel footer</div>
        </div>

    </div>
    <script>
        function BeforeFormSubmit(ele) {
            $(":disabled").removeAttr('disabled');

            if($('#uploaded_files').children().length === 0){
                alert('请上传证件信息');
                return false
            }
            if(!$("input[name='contract_agreed']").prop('checked')){
                alert('必须勾选协议');
                return false
            }
            //return false
        }

    </script>

{% endblock body %}
{% block extra-js %}
    <script src="{% static 'plugins/dropzone/dropzone.js' %}"></script>
 <script>


        // "myAwesomeDropzone" is the camelized version of the HTML element's ID
        Dropzone.options.myAwesomeDropzone = {
          paramName: "file", // The name that will be used to transfer the file
          maxFilesize: 2, // 文件最大是2MB
          maxFiles:2,      //最大上传文件数
          parallelUploads:1, // 并发数目
          accept: function(file, done) {
            if (file.name === "justinbieber.jpg") {
              done("Naha, you don't.");
            }
            else { done(); }
          }
        };

        $(function() {
          // Now that the DOM is fully loaded, create the dropzone, and setup the
          // event listeners
          // Prevent Dropzone from auto discovering this element:
          Dropzone.options.myAwesomeDropzone = false;
          var myDropzone = new Dropzone("#myAwesomeDropzone");
          myDropzone.on("success", function(file,response) {
            /* Maybe display some more file information on your page */
             //console.log("completet", file, response);
             var response = JSON.parse(response);
             if (!response.status){
                 alert(response.err_msg);
             }else {
                 $("#uploaded_files").append("<li>"+ file.name +"</li>");

             }

          });
        })

    </script>

{% endblock extra-js %}
```

views.py

```python
...
def enrollment(request,enrollment_id):
    """学员在线报名表地址"""
    enrollment_obj = models.StudentEnrollment.objects.get(id=enrollment_id)
    if enrollment_obj.contract_agreed:
        return HttpResponse("报名合同正在审核中....")
    if request.method == 'POST':
        # print('enrollment:' ,request.POST)
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer,data=request.POST)
        if customer_form.is_valid():
            # print(customer_form.cleaned_data)
            # customer_form.save()
            enrollment_obj.contract_agreed = True
            enrollment_obj.contract_signed_date = datetime.now()
            enrollment_obj.save()
            return HttpResponse('您已成功提交报名信息，请等待审核')

        # print('form err',customer_form.errors)
    else:
        customer_form = forms.CustomerForm(instance=enrollment_obj.customer)
    # 列出已上传的文件
    uploaded_files = []
    enrollment_upload_dir = os.path.join(conf.settings.CRM_FILE_UPLOAD_DIR,enrollment_id)
    if os.path.isdir(enrollment_upload_dir):
        uploaded_files = os.listdir(enrollment_upload_dir)


    return render(request,'crm/enrollment.html',locals())
    ...
```

#### ④审核

###### 1）页面

urls.py

```python
   path('stu_enrollment/<str:enrollment_id>/contract_audit/',views.contract_audit,name='contract_audit'),
```

views.py

```python
...
@login_required
def stu_enrollment(request):
    customers = models.CustomerInfo.objects.all()
    class_lists = models.ClassList.objects.all()
    if request.method == 'POST':
        customer_id = request.POST.get('customer_id')
        class_grade_id = request.POST.get('class_grade_id')
        try:
            enrollment_obj = models.StudentEnrollment.objects.create(
                customer_id=customer_id,
                class_grade_id=class_grade_id,
                consulant_id=request.user.userprofile.id
            )
        except IntegrityError as e:  # 代表已经生成报名表
            enrollment_obj = models.StudentEnrollment.objects.get(customer_id=customer_id,
                                                                  class_grade_id=class_grade_id)
            if enrollment_obj.contract_agreed:
                return redirect('/crm/stu_enrollment/%s/contract_audit/' % enrollment_obj.id)

        enrollment_link = 'http://localhost:8000/crm/enrollment/%s/' % enrollment_obj.id

    return render(request, 'crm/stu_enrollment.html', locals())
...
@login_required
def contract_audit(request, enrollment_id):
    enrollment_obj = models.StudentEnrollment.objects.get(id=enrollment_id)
    customer_form = forms.CustomerForm(instance=enrollment_obj.customer)

    enrollment_form = forms.EnrollmentForm(instance=enrollment_obj)

    return render(request, 'crm/contract_audit.html',locals())
```

forms.py

```python
class EnrollmentForm(ModelForm):
    def __new__(cls, *args, **kwargs):
        # print('__new__', cls, args, kwargs)
        # print(cls.base_fields)
        for field_name in cls.base_fields:
            field_obj = cls.base_fields[field_name]
            field_obj.widget.attrs.update({'class': 'form-control'})

            if field_name in cls.Meta.readonly_fields:
                field_obj.widget.attrs.update({'disabled': 'true'})

        return ModelForm.__new__(cls)

    class Meta:  # 关联表
        model = models.StudentEnrollment
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段
        exclude = ['contract_approved_date']
        readonly_fields = ['contract_agreed']

    def clean(self):  # form 保存之前会调用
        if self.errors:
            raise forms.ValidationError(("Please fix errors before re-submit."))
        if self.instance.id is not None:  # means this is a change form ,should check the readonly fields
            for field in self.Meta.readonly_fields:
                old_field_val = getattr(self.instance, field)  # 数据库里的数据
                form_val = self.cleaned_data.get(field)
                # print("filed differ compare:", old_field_val, form_val)
                if old_field_val != form_val:
                    # add_error 字段错误
                    self.add_error(field, "Readonly Field: field should be '{value}' ,not '{new_value}' ". \
                                   format(**{'value': old_field_val, 'new_value': form_val}))

```

contract_audit.html

```html
{% extends 'index.html' %}

{% block right-content-containter %}
    <h3>学员报名|审核</h3>
    <h4>学员报名表</h4>
    <form class="form-horizontal" method="post">{% csrf_token %}
        {{ customer_form }}

        <hr>
        <h4>学员审核表</h4>
        {{ enrollment_form }}

        <input type="submit" class="btn btn-success pull-right" value="审核通过">


    </form>
{% endblock right-content-containter %}
```

###### 2）功能开发

contract_audit.html

```html
{% extends 'index.html' %}

{% block right-content-containter %}
    <h3>学员报名|审核</h3>
    <h4>学员报名表</h4>
    <form class="form-horizontal" method="post" onsubmit="BeforeFormSubmit(this)">{% csrf_token %}
        {{ customer_form }}

        <hr>
        <h4>学员审核表</h4>
        {{ enrollment_form }}


        <input type="submit" class="btn btn-success pull-right" value="审核通过">


    </form>
    <script>
        function BeforeFormSubmit(ele) {
            $(":disabled").removeAttr('disabled');

        }
    </script>

{% endblock right-content-containter %}
```

views.py

```python
@login_required
def contract_audit(request, enrollment_id):
    enrollment_obj = models.StudentEnrollment.objects.get(id=enrollment_id)
    if request.method == 'POST':

        enrollment_form = forms.EnrollmentForm(instance=enrollment_obj,data=request.POST)
        if enrollment_form.is_valid():
            enrollment_form.save()
            stu_obj = models.Student.objects.get_or_create(customer=enrollment_obj.customer)[0]
            stu_obj.class_grades.add(enrollment_obj.class_grade_id)
            stu_obj.save()

            enrollment_obj.customer.status = 1
            enrollment_obj.customer.save()
            return redirect('/useradmin/crm/customerinfo/%s/change/'%enrollment_obj.customer.id)
    else:

        customer_form = forms.CustomerForm(instance=enrollment_obj.customer)

        enrollment_form = forms.EnrollmentForm(instance=enrollment_obj)

    return render(request, 'crm/contract_audit.html',locals())
```

useradmin.py

```python
from useradmin.sites import site
from useradmin.admin_base import BaseUserAdmin

from crm import models


# print('crm useradmin ...')


class CustomerAdmin(BaseUserAdmin):
    list_display = ['id', 'name', 'source', 'contact_type', 'contact', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    readonly_fields = ['contact', 'status']  # 只读，不可修改字段
    filter_horizontal = ['consult_courses']
    # list_per_page = 5
    actions = ['change_status', ]

    def change_status(self, request, querysets):
        # print('admin action', self, request, querysets)
        # print('----------',self,request,querysets)
        querysets.update(status=0)

class StudentAdmin(BaseUserAdmin):
    filter_horizontal = ['class_grades']

site.register(models.CustomerInfo, CustomerAdmin)
site.register(models.Role)
site.register(models.Menus)
site.register(models.Course)
site.register(models.ClassList)
site.register(models.CourseRecord)
site.register(models.StudyRecord)
site.register(models.UserProfile)
site.register(models.Student,StudentAdmin)

```

