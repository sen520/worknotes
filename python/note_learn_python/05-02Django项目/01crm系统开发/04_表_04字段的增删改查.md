## 1、修改功能

#### 1、链接

为了方便使用，我们先将每页显示的数据改为5

```
paginator = Paginator(querysets, 5)  # 获取对象，每页几个
```

form表单和AJAX的优劣势：

​	AJAX		不刷新页面就能获取数据，但如果只是前端进行验证，可能不通过浏览器发送请求

​				

​	form表单	后端有验证的功能

​	model form	form和数据库中的数据绑定

配置链接

useradmin_tags.py

```python
@register.simple_tag
def build_table_row(obj, admin_class):
    """生成一条记录的html element"""

    ele = ''
    if admin_class.list_display:
        for index,column_name in enumerate(admin_class.list_display): # 获取下标
            colum_obj = admin_class.model._meta.get_field(column_name)
            if colum_obj.choices:  # get_xxx_display
                column_data = getattr(obj, 'get_%s_display' % column_name)()  # 获取对象中的方法
            else:
                column_data = getattr(obj, column_name)

            td_ele = '<td>%s</td>' % column_data

            if index == 0:
                td_ele = '<td><a href="%s/change/">%s</a></td>'% (obj.id,column_data)

            ele += td_ele
    else:
        td_ele = '<td><a href="%s/change/">%s</a><td>' % (obj.id,obj)  # 默认返回str方法
        ele += td_ele
    return mark_safe(ele)
```

#### 2、显示页面

##### 1）配置url

useradmin/urls.py

```python
    ...
    path('<str:app_name>/<str:model_name>/<int:obj_id>/change/', views.table_obj_change, name='table_obj_change'),
...
```

##### 2）配置页面

###### ①配置

useradmin/views.py

```python
@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    return render(request,'useradmin/table_obj_change.html')

```

useradmin/templates/useradmin/table_obj_change.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h2 class="page-header">App</h2>
    <div>
        change
    </div>
{% endblock right-content-container %}
```

效果

![04_04 前端效果图07](.\img\04_04 前端效果图07.png)

###### 附：先尝试一下django静态form

新建crm/forms.py

```python
from django.forms import ModelForm
from crm import models


class CustomerForm(ModelForm):
    class Meta: # 关联表
        model = models.CustomerInfo
        fields = ['name', 'consultant', 'status']
```

useradmin/views.py

```python
@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    from crm import forms
    form = forms.CustomerForm()
    return render(request,'useradmin/table_obj_change.html',locals())
```

table_obj_change.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h2 class="page-header">App</h2>
    <div>
        change

    	{{ form }}
    </div>
{% endblock right-content-container %}
```

![04_04 django静态form](.\img\04_04 django静态form.png)

###### ②动态表单

创建类就可以有两种方式：

a). 普通方式 

```python
class Foo(object):
  
    def func(self):
        print 'hello alex'
```

b). 特殊方式

```python
def func(self):
    print 'hello wupeiqi'
  
Foo = type('Foo',(object,), {'func': func})
#type第一个参数：类名
#type第二个参数：当前类的基类
#type第三个参数：类的成员

>>> def sayhi():
...     print('hey')
...
>>> f = type('Foo',(object,),{'func':sayhi})
>>> f
<class '__main__.Foo'>
>>> obj = f
>>> obj.sayhi()
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
AttributeError: type object 'Foo' has no attribute 'sayhi'
>>> obj.func()
hey
```

useradmin/form_handle.py

```python
from django.forms import ModelForm


def create_dynamic_model_form(admin_class):
    """动态生成modelform"""

    class Meta:
        model = admin_class.model
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段

    dynamic_form = type('DynamicModelForm', (ModelForm,), {'Meta': Meta})
    print(dynamic_form)
```

useradmin/views.py

```python
from useradmin import form_handle
...

@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class)

    return render(request,'useradmin/table_obj_change.html',locals())

...
```

控制台打印\<class 'django.forms.widgets.DynamicModelForm'>

useradmin/form_handle.py

```python
...
    dynamic_form = type('DynamicModelForm', (ModelForm,), {'Meta': Meta})
    # print(dynamic_form)
    return dynamic_form
```

useradmin/views.py

```python
@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class)
    form_obj = model_form()

    return render(request,'useradmin/table_obj_change.html',locals())
```

table_obj_change.html

```html
    <div>
        change

    {{ form_obj }}
    </div>
```

![04_04 前端效果图08](.\img\04_04 前端效果图08.png)

再查看别的表，已经做到动态生成，只是页面很。。。

###### ③动态菜单-添加样式

table_obj_change.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h2 class="page-header">App</h2>
    <div>
        change
        <form class="form-horizontal">
            {% for field in form_obj %}
                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2 control-label">{{ field.label }}</label>
                    <div class="col-sm-10">
                        {{ field }}
                    </div>
                </div>
            {% endfor %}
        </form>

    </div>
{% endblock right-content-container %}
```

此时显示正常，但是可以发现并没有样式（不能用JS加样式，JS会有延迟）

重写\__new__方法

测试：

crm/forms.py

```python
...
class CustomerForm(ModelForm):
    class Meta:  # 关联表
        model = models.CustomerInfo
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段

    def __new__(cls, *args, **kwargs):
        print('__new__', cls, args, kwargs)
        print(cls.base_fields)
        for field_name in cls.base_fields:
            field_obj = cls.base_fields[field_name]
            field_obj.widget.attrs.update({'class':'form-control'})


        return ModelForm.__new__(cls)
```

useradmin/views.py

```python
@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    # admin_class = site.enabled_admins[app_name][model_name]
    # model_form = form_handle.create_dynamic_model_form(admin_class)
    # form_obj = model_form()

    from crm.forms import CustomerForm
    form_obj = CustomerForm()

    return render(request,'useradmin/table_obj_change.html',locals())
```

可以看到控制台打印了：

```python
__new__ <class 'crm.forms.CustomerForm'> () {}


# 表中所有字段的对象
OrderedDict([('name', <django.forms.fields.CharField object at 0x000002091FB385F8>), ('contact_type', <django.forms.fields.TypedChoiceField object at 0x000002091FB56128>), ('contact', <django.forms.fields.CharField object at 0x000002091FB56208>), ('source', <django.forms.fields.TypedChoiceField object at 0x000002091FB563C8>), ('referral_from', <django.forms.models.ModelChoiceField object at 0x000002091FB56390>), ('consult_courses', <django.forms.models.ModelMultipleChoiceField object at 0x000002091FB56438>), ('consult_content', <django.forms.fields.CharField object at 0x000002091FB566A0>), ('status', <django.forms.fields.TypedChoiceField object at 0x000002091FB567B8>), ('consultant', <django.forms.models.ModelChoiceField object at 0x000002091FB56828>)])

```

所以

useradmin/form_handle.py

```python
from django.forms import ModelForm


def create_dynamic_model_form(admin_class):
    """动态生成modelform"""

    class Meta:
        model = admin_class.model
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段

    def __new__(cls, *args, **kwargs):
        # print('__new__', cls, args, kwargs)
        # print(cls.base_fields)
        for field_name in cls.base_fields:
            field_obj = cls.base_fields[field_name]
            field_obj.widget.attrs.update({'class':'form-control'})


        return ModelForm.__new__(cls)

    dynamic_form = type('DynamicModelForm', (ModelForm,), {'Meta': Meta,'__new__':__new__})
    # print(dynamic_form)
    return dynamic_form
```

useradmin/views.py

```python
...
@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class)
    form_obj = model_form()

    # from crm.forms import CustomerForm
    # form_obj = CustomerForm()

    return render(request,'useradmin/table_obj_change.html',locals())
...
```

###### ④功能实现

修改table_obj_change.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h3 class="page-header">{% get_model_name admin_class %}</h3>
    <h4 class="page-header">修改{{ form_obj.instance }}</h4>
    ...
```

useradmin/views.py 为表单添加已有信息

```python
@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class)
    obj = admin_class.model.objects.get(id=obj_id)
    form_obj = model_form(instance=obj)

    # from crm.forms import CustomerForm
    # form_obj = CustomerForm()

    return render(request,'useradmin/table_obj_change.html',locals())
```

table_obj_change.html 表单改为post，发送到后端

```html
...
<form class="form-horizontal" method="post">
    {% csrf_token %}
...
```

useradmin/views.py

```python
@login_required
def table_obj_change(request,app_name,model_name,obj_id):
    """useradmin 数据修改页面"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class)
    obj = admin_class.model.objects.get(id=obj_id)
    if request.method == 'GET':
        form_obj = model_form(instance=obj)
    elif request.method =='POST':
        form_obj = model_form(instance=obj,data=request.POST)
        if form_obj.is_valid():
            form_obj.save()
            return redirect('/useradmin/%s/%s/'%(app_name,model_name))
        

    # from crm.forms import CustomerForm
    # form_obj = CustomerForm()

    return render(request,'useradmin/table_obj_change.html',locals())


```

如果输入的错误有误，在前端判断

table_obj_change.html

```html
            {% for field in form_obj %}
                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2 control-label">{{ field.label }}</label>
                    <div class="col-sm-10">
                        {{ field }}
                        <span style="color:red">{{ field.errors.0 }}</span>
                    </div>
                </div>
            {% endfor %}
```

## 2、添加功能

#### 1、配置url

useradmin/urls.py

```python
    path('<str:app_name>/<str:model_name>/add/', views.table_obj_add, name='table_obj_add'),
```

#### 2、显示页面

useradmin/views.py

```python
def table_obj_add(request,app_name,model_name):
    """添加数据"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class)
    if request.method == 'GET':
        form_obj = model_form()

    return render(request, 'useradmin/table_obj_add.html', locals())
```

新建useradmin/templates/useradmin/table_obj_add.html

由于添加修改中的模板一致，所以我们新建table_obj_change_component.html

修改table_obj.change.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h3 class="page-header">{% get_model_name admin_class %}</h3>
    <h4 class="page-header">修改{{ form_obj.instance }}</h4>
    <div>
    {% include 'useradmin/table_obj_change_component.html' %}

    </div>
{% endblock right-content-container %}
```

table_obj_change_component.html

```html
        <form class="form-horizontal" method="post">
            {% csrf_token %}
            {% for field in form_obj %}
                <div class="form-group">
                    <label for="inputEmail3" class="col-sm-2 control-label">{{ field.label }}</label>
                    <div class="col-sm-10">
                        {{ field }}
                        <span style="color:red">{{ field.errors.0 }}</span>
                    </div>
                </div>
            {% endfor %}

            <div class="form-group">
                <div class="col-sm-offset-11 col-sm-10">
                    <button type="submit" class="btn btn-info">Save</button>
                </div>
            </div>


        </form>
```

table_obj_add.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h3 class="page-header">{% get_model_name admin_class %}</h3>
    <h4 class="page-header">添加{% get_model_name admin_class %}数据</h4>
    <div>
        {% include 'useradmin/table_obj_change_component.html' %}

    </div>
{% endblock right-content-container %}
```

访问http://127.0.0.1:8000/useradmin/crm/customerinfo/add/

#### 3、配置后台

useradmin/views.py

```python
def table_obj_add(request,app_name,model_name):
    """添加数据"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class)
    if request.method == 'GET':
        form_obj = model_form()
    elif request.method =='POST':
        form_obj = model_form(data=request.POST)
        if form_obj.is_valid():
            form_obj.save()
            return redirect('/useradmin/%s/%s/'%(app_name,model_name))

    return render(request, 'useradmin/table_obj_add.html', locals())
```

此时可以保存，但是保存的数据默认放到最后一条

useradmin/views.py

```python
def table_obj_list(request, app_name, model_name):
    """取出指定的model里的数据返回给前端"""
    # print('app_name,model_name:',site.enabled_admins[app_name][model_name])
    admin_class = site.enabled_admins[app_name][model_name]
    # print(request.GET)
    # 打印结果：<QueryDict: {'source': ['1'], 'consultant': ['2'], 'status': ['0'], 'date': ['2018-07-01 11:19:26.324492']}>
    # print('admin_class',admin_class.model)

    querysets = admin_class.model.objects.order_by('-id')
```

#### 4、修改BUG

useradmin_tags.py

```python
@register.simple_tag
def get_available_m2m_data(field_name, form_obj, admin_class):
    """返回的是m2m字段关联表的所有数据"""
    field_obj = admin_class.model._meta.get_field(field_name)
    obj_list = set(field_obj.related_model.objects.all())
    if form_obj.instance.id:

        selected_data = set(getattr(form_obj.instance, field_name).all())

        return obj_list - selected_data
    return obj_list



@register.simple_tag
def get_selected_m2m_data(field_name, form_obj, admin_class):
    """返回已选的m2m数据"""
    if form_obj.instance.id:
        selected_data = getattr(form_obj.instance, field_name).all()

        return selected_data
```

table_obj_change_component.html

{% if form_obj.instance  %}  ====>  {% if form_obj.instance.id %}



## 附：

### ①只读字段的处理

目前状态、contact是不能修改的，此时需要处理一下

django中是有这个功能的

#### （1）修改

crm/admin.py

```python
class CustomerAdmin(admin.ModelAdmin):
    list_display = ['id','name', 'contact', 'contact_type', 'source', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    # list_per_page = 2
    readonly_fields = ['contact','status']
```

运行就可以发现，这两个字段不能修改了，我们现在来实现这个功能

useradmin/admin_base.py配置默认字段

```python
class BaseUserAdmin(object):
    list_display = []
    list_filter = []
    search_fields = []
    readonly_fields = []
```

crm/useradmin.py配置只读字段

```python
class CustomerAdmin(BaseUserAdmin):
    list_display = ['id','name', 'source', 'contact_type', 'contact', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    readonly_fields = ['contact', 'status'] # 只读，不可修改字段
```

useradmin/form_handle.py判断字段是否为只读字段

```python
    def __new__(cls, *args, **kwargs):
        # print('__new__', cls, args, kwargs)
        # print(cls.base_fields)
        for field_name in cls.base_fields:
            field_obj = cls.base_fields[field_name]
            field_obj.widget.attrs.update({'class':'form-control'})
            if field_name in admin_class.readonly_fields:
                field_obj.widget.attrs.update({'disabled': 'true'})
                ...
```

运行提交，会提示只读字段为空

useradmin/form_handle.py添加不验证字段

```python
    class Meta:
        model = admin_class.model
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段
        exclude = admin_class.readonly_fields # 不验证
```

这样就可以提交，前端没有显示。

在前端显示我们设置的只读字段

table_obj_change_component.html

```html
{% load useradmin_tags %}
<form class="form-horizontal" method="post">
    {% csrf_token %}
    {% for field in form_obj %}
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">{{ field.label }}</label>
            <div class="col-sm-10">
                {{ field }}
                <span style="color:red">{{ field.errors.0 }}</span>
            </div>
        </div>
    {% endfor %}
    {% for field in admin_class.readonly_fields %}
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">{{ field }}</label>
            <div class="col-sm-10">
                <p>{% get_obj_field_val form_obj field %}</p>
            </div>
        </div>
    {% endfor %}

    <div class="form-group">
        <div class="col-sm-offset-11 col-sm-10">
            <button type="submit" class="btn btn-info">Save</button>
        </div>
    </div>


</form>
```

useradmin_tags.py

```python
@register.simple_tag
def get_obj_field_val(form_obj,field):
    """返回model obj 具体字段的值"""

    return getattr(form_obj.instance,field)
```

#### （2）添加

此时添加时不能添加那两个字段

useradmin/views.py 添加的时候增加一个判断

```python
def table_obj_add(request,app_name,model_name):
    """添加数据"""
    admin_class = site.enabled_admins[app_name][model_name]
    model_form = form_handle.create_dynamic_model_form(admin_class,form_add=True)
    if request.method == 'GET':
        form_obj = model_form()
    elif request.method =='POST':
        form_obj = model_form(data=request.POST)
        if form_obj.is_valid():
            form_obj.save()
            return redirect('/useradmin/%s/%s/'%(app_name,model_name))

    return render(request, 'useradmin/table_obj_add.html', locals())
```

useradmin/form_handle.py

```python
    class Meta:
        model = admin_class.model
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段
        if not form_add:
            exclude = admin_class.readonly_fields # 不验证
```

因为前端是个p标签，所以还要对前端进行修改

useradmin/form_handle.py

```python
    class Meta:
        model = admin_class.model
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段
        if not form_add: # change
            exclude = admin_class.readonly_fields # 不验证
        else: # add
            admin_class.form_add = True
```

table_obj_change_component.html

```html
    {% if not admin_class.form_add %} <!--如果这是修改表单-->
        {% for field in admin_class.readonly_fields %}
            <div class="form-group">
                <label for="inputEmail3" class="col-sm-2 control-label">{{ field }}</label>
                <div class="col-sm-10">
                    <p>{% get_obj_field_val form_obj field %}</p>
                </div>
            </div>
        {% endfor %}
    {% endif %}
```

（3）修改BUG

此时修改页面，只读字段不显示

form_handle.py

```python
    class Meta:
        model = admin_class.model
        # fields = ['name', 'consultant', 'status']
        fields = '__all__'  # 所有字段
        if not form_add: # change
            admin_class.form_add = False # 修改属性为False,为了避免上一次添加调用将其修改为True
            exclude = admin_class.readonly_fields # 不验证
        else: # add
            admin_class.form_add = True
```

### ②多选字段

如果多选字段过多的情况下，django中有一个filter_horizontal的配置

crm/admin.py

```python
class CustomerAdmin(admin.ModelAdmin):
    list_display = ['id','name', 'contact', 'contact_type', 'source', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    # list_per_page = 2
    readonly_fields = ['contact','status']
    filter_horizontal = ['consult_courses']
```

显示页面：

![04_04filter_horizontal](.\img\04_04filter_horizontal.png)

#### （1）左边

table_obj_change_component.html

```html
            <div class="col-sm-10">
                {% if field.name in admin_class.filter_horizontal %}
                    <div class="col-lg-5">
                        <select multiple class="form-control">
                            {% get_available_m2m_data field.name admin_class as get_available_m2m_data%}
                            <!--as 有返回值的存储一个变量-->
                            {% for obj in get_available_m2m_data %}
                                <option value="{{ obj.id }}">{{ obj }}</option>
                            {% endfor %}

                        </select>
                    </div>
                    <div class="col-lg-5">

                    </div>
                {% else %}
                    {{ field }}
                {% endif %}
                <span style="color:red">{{ field.errors.0 }}</span>
            </div>
```

useradmin_tags.py

```python
@register.simple_tag
def get_available_m2m_data(field_name, admin_class):
    """返回的是m2m字段关联表的所有数据"""
    field_obj = admin_class.model._meta.get_field(field_name)
    obj_list = field_obj.related_model.objects.all()
    return obj_list
```

admin_base.py

```python
class BaseUserAdmin(object):
    list_display = []
    list_filter = []
    search_fields = []
    readonly_fields = []
    filter_horizontal = []
```

crm/useradmin.py

```python
class CustomerAdmin(BaseUserAdmin):
    list_display = ['id', 'name', 'source', 'contact_type', 'contact', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    readonly_fields = ['contact', 'status']  # 只读，不可修改字段
    filter_horizontal = ['consult_courses']
```

#### （2）右边

table_obj_change_component.html

```html
<div class="col-lg-5">
    <select multiple class="form-control">
        {% get_selected_m2m_data field.name form_obj admin_class as selected_m2m_data %}
        {% for obj in selected_m2m_data %}
        	<option value="{{ obj.id }}">{{ obj }}</option>
        {% endfor %}
    </select>
</div>
```

useradmin_tags.py

```python
@register.simple_tag
def get_available_m2m_data(field_name, form_obj,admin_class):
    """返回的是m2m字段关联表的所有数据"""
    field_obj = admin_class.model._meta.get_field(field_name)
    obj_list = set(field_obj.related_model.objects.all())

    selected_data = set(getattr(form_obj.instance,field_name).all())

    return obj_list-selected_data

@register.simple_tag
def get_selected_m2m_data(field_name,form_obj,admin_class):
    """返回已选的m2m数据"""
    selected_data = getattr(form_obj.instance,field_name).all()

    return selected_data
```

（3）左右关联

双击事件

table_obj_change_component.html

```html
            <div class="col-sm-10">
                {% if field.name in admin_class.filter_horizontal %}
                    <div class="col-lg-5">
                        <select id="id_{{ field.name }}_from" multiple class="form-control">
                            {% get_available_m2m_data field.name form_obj admin_class as available_m2m_data%}
                            <!--as 有返回值的存储一个变量-->
                            {% for obj in available_m2m_data %}
                                <option ondblclick="MoveSelectedOption(this,'id_{{ field.name }}_to')" value="{{ obj.id }}">{{ obj }}</option>
                            {% endfor %}

                        </select>
                    </div>
                    <div class="col-lg-5">
                        <select tag="selected_m2m" id="id_{{ field.name }}_to" multiple class="form-control" name="{{ field.name }}">
                        {% get_selected_m2m_data field.name form_obj admin_class as selected_m2m_data %}
                            {% for obj in selected_m2m_data %}
                                <option value="{{ obj.id }}" ondblclick="MoveSelectedOption(this,'id_{{ field.name }}_from')" >{{ obj }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}
                <span style="color:red">{{ field.errors.0 }}</span>
            </div>
...
<script>
    function MoveSelectedOption(ele,target_id) {

        var new_target_id = $(ele).parent().attr('id');
        var option = "<option value='"+$(ele).val()+"' ondblclick=MoveSelectedOption(this,'"+ new_target_id +"')>" + $(ele).text() + "</option>";
        $('#' + target_id).append(option);
        $(ele).remove();
    }

    function VerificationBeforeRormSubmit() {
        $('select[tag] option').prop('selected',true); 修改属性值
    }
</script>
```

#### （3）为上述功能添加全选

table_obj_change_component.html

```html
...
                {% if field.name in admin_class.filter_horizontal %}
                    <div class="col-lg-5">
                        <select id="id_{{ field.name }}_from" multiple class="form-control">
                            {% get_available_m2m_data field.name form_obj admin_class as available_m2m_data %}
                            <!--as 有返回值的存储一个变量-->
                            {% for obj in available_m2m_data %}
                                <option ondblclick="MoveSelectedOption(this,'id_{{ field.name }}_to')"
                                        value="{{ obj.id }}">{{ obj }}</option>
                            {% endfor %}

                        </select>
                        <p><a onclick="MoveAllElements('id_{{ field.name }}_from','id_{{ field.name }}_to')">Choose
                            All</a></p>


                    </div>
                    <div class="col-lg-5">
                        <select tag="selected_m2m" id="id_{{ field.name }}_to" multiple class="form-control"
                                name="{{ field.name }}">
                            {% get_selected_m2m_data field.name form_obj admin_class as selected_m2m_data %}
                            {% for obj in selected_m2m_data %}
                                <option value="{{ obj.id }}"
                                        ondblclick="MoveSelectedOption(this,'id_{{ field.name }}_from')">{{ obj }}</option>
                            {% endfor %}
                        </select>
                        <p><a onclick="MoveAllElements('id_{{ field.name }}_to','id_{{ field.name }}_from')">Remove
                            All</a></p>

                    </div>
                {% else %}
...
<script>
...
    function MoveAllElements(from_id, to_id) {
        //console.log($('#'+from_id).children())
        $('#' + from_id).children().each(function () {
            MoveSelectedOption(this, to_id);
        })
    }
...
</script>
```

#### （4）搜索

```html
...
<div class="col-lg-5">
    <input type="search" class="form-control" oninput="FuzzSearch(this)">
    <select id="id_{{ field.name }}_from" multiple class="form-control">

    {% get_available_m2m_data field.name form_obj admin_class as available_m2m_data %}
    <!--as 有返回值的存储一个变量-->
    {% for obj in available_m2m_data %}
    <option ondblclick="MoveSelectedOption(this,'id_{{ field.name }}_to')"
    value="{{ obj.id }}">{{ obj }}</option>
    {% endfor %}

    </select>
    <p><a onclick="MoveAllElements('id_{{ field.name }}_from','id_{{ field.name }}_to')">Choose
    All</a></p>


</div>
...
<script>
    ...
    function FuzzSearch(ele) {
        //console.log($(ele).val());
        var search_text = $(ele).val().toLowerCase(); //变小写，使搜索时大小写不分
        $(ele).next().children().each(function () {
            if ($(this).text().toLowerCase().search(search_text) !== -1){
                //console.log($(ele).val());
                $(this).show();
            }else{
                //console.log($(ele).val());
                $(this).hide();
            }
        })


    }

    ...
</script>
```



## 3、删除功能

#### （1）界面

```python
a._meta.fields()			查询外键
a._meta.fields_map()		查询反向关联
a._meta.related_objects()	查询多对多
```

useradmin/

urls.py

```python
...
    path('<str:app_name>/<str:model_name>/<int:obj_id>/delete/', views.table_obj_delete, name='obj_delete'),
    ...
```

views.py

```python
...
def table_obj_delete(request, app_name, model_name, obj_id):
    admin_class = site.enabled_admins[app_name][model_name]
    obj = admin_class.model.objects.get(id=obj_id)

    return render(request, 'useradmin/table_obj_delete.html', locals())
...
```

新建tamplates/useradmin/table_obj_delete.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h3 class="page-header">{% get_model_name admin_class %}</h3>
    <h4 class="page-header">修改{{ form_obj.instance }}</h4>
    <div>
    delete
    {{ obj }}
    {% display_all_related_objs obj %}


    </div>
{% endblock right-content-container %}
```

useradmin_tags.py

```python
@register.simple_tag
def display_all_related_objs(obj):
    "显示要被删除对象的所有关联对象"
    ele = '<ul><li>%s</li>'%obj

    # 判断反向关联
    # a._meta.fields_map()    查询反向关联
    for reversed_fk_obj in obj._meta.related_objects:
        related_table_name = reversed_fk_obj.name
        related_lookup_key = '%s_set' % related_table_name
        related_objs = getattr(obj, related_lookup_key).all()  # 反向查找所有关联的数据
        ele += '<li>%s<ul>' % related_table_name
        for i in related_objs:
            ele += '<li>%s</li>'%i

        ele += '</ul></li>'
    ele += '</ul>'

    return mark_safe(ele)
```

![04_04 删除功能01](.\img\04_04 删除功能01.png)

实现多层级（使用递归）

useradmin_tags.py

```python
@register.simple_tag
def display_all_related_objs(obj):
    "显示要被删除对象的所有关联对象"
    ele = '<ul>'
    # ele = '<ul><li><a href="/useradmin/%s/%s/%s/change">%s</a></li>' % \
    #       (obj._meta.app_label,obj._meta.model_name,obj.id,obj)

    # 判断反向关联
    # a._meta.fields_map()    查询反向关联
    for reversed_fk_obj in obj._meta.related_objects:

        related_table_name = reversed_fk_obj.name
        related_lookup_key = '%s_set' % related_table_name
        related_objs = getattr(obj, related_lookup_key).all()  # 反向查找所有关联的数据
        ele += '<li>%s<ul>' % related_table_name

        if reversed_fk_obj.get_internal_type() == 'ManyToManyField':
            # 不需要深入查找
            for i in related_objs:
                ele += '<li><a href="/useradmin/%s/%s/%s/change/">%s</a> 记录里与[%s]相关的数据将被删除</li>' % (
                i._meta.app_label, i._meta.model_name, i.id, i, obj)
        else:
            for i in related_objs:
                # ele += '<li>%s</li>' % i
                ele += '<li><a href="/useradmin/%s/%s/%s/change">%s</a></li>' % \
                      (i._meta.app_label, i._meta.model_name, i.id, i)

                ele += display_all_related_objs(i)

        ele += '</ul></li>'
    ele += '</ul>'

    return ele
```

table_obj_delete.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h3 class="page-header">{% get_model_name admin_class %}</h3>
    <h4 class="page-header">注意：以下与{{ obj }}相关的数据都将被删除</h4>
    <div>
        delete
        {{ obj }}
        {% display_all_related_objs obj as  all_related_obj_ele %}
        {{ all_related_obj_ele |safe }}
        <form method="post">{% csrf_token %}
            <input type="submit" class="btn btn-danger" value="确认删除">
                    <form method="post">{% csrf_token %}
            <input type="submit" class="btn btn-danger" value="确认删除">
            <a class="btn btn-info" href="/useradmin/{{app_name}}/{{ model_name }}/{{ obj_id }}/change">返回</a>
        </form>
        </form>


    </div>
{% endblock right-content-container %}
```

#### （2）实现

useradmin/views.py

```python
...

def table_obj_delete(request, app_name, model_name, obj_id):
    admin_class = site.enabled_admins[app_name][model_name]
    obj = admin_class.model.objects.get(id=obj_id)
    if request.method == 'POST':
        obj.delete()
        return redirect('/useradmin/{app_name}/{model_name}/'.format(app_name=app_name,model_name=model_name))
    return render(request, 'useradmin/table_obj_delete.html', locals())


...
```

#### （3）解决BUG

我们在删除有多个字段关联的时候，可能会出现FOREIGNKEY的错误，是因为我们在定义表的外键的时候，把on_delete设置成了DO_NOTHING，把这些字段设置成CASCADE，然后再重新生成表就可以了。

## 4、自定义分页功能

useradmin/admin_base.py

```python
class BaseUserAdmin(object):
    list_display = []
    list_filter = []
    search_fields = []
    readonly_fields = []
    filter_horizontal = []
    list_per_page = 20  # 默认20
```

useradmin/views.py

```python
    ...
    paginator = Paginator(querysets, admin_class.list_per_page)  # 获取对象，每页几个
    ...
```

crm/useradmin.py

```python
class CustomerAdmin(BaseUserAdmin):
    list_display = ['id', 'name', 'source', 'contact_type', 'contact', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    readonly_fields = ['contact', 'status']  # 只读，不可修改字段
    filter_horizontal = ['consult_courses']
    list_per_page = 5
...
```

## 5、多选

#### 1、django中

crm/admin.py

```python
class CustomerAdmin(admin.ModelAdmin):
    list_display = ['id', 'name', 'contact', 'contact_type', 'source', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    # list_per_page = 2
    # readonly_fields = ['contact','status']
    filter_horizontal = ['consult_courses']
    actions = ['change_status', ]

    def change_status(self, request, querysets):
        # print('admin action', self, request, querysets)
        querysets.update(status=1)
...
```

#### 2、批量修改

###### 1）定制前端页面

table_obj_list.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h2 class="page-header">App</h2>
    <div>
        {#    {{ querysets }}#}

        <form>
            <input type="search" name="_q" value="{{ admin_class.search_key }}"
                   placeholder="{% for s in admin_class.search_fields %}{{ s }},{% endfor %}">
            <input type="submit" value="Search">

            {% for k,v in admin_class.filter_conditions.items %}
                <input type="hidden" name="{{ k }}" value="{{ v }}">
            {% endfor %}

        </form>
        <hr>
        <div class="row">
            {% if admin_class.list_filter %}
                <form>
                    {% for filter_column in admin_class.list_filter %}
                        {% build_filter_ele filter_column admin_class %}
                    {% endfor %}
                    <input type="hidden" name="_o" value="{% get_current_sorted_colum_index sorted_column %}">
                    <br>
                    <input class="btn btn-success" type="submit" value="确定">
                </form>
            {% endif %}

        </div>
        <br>
        <form onsubmit="return ActionCheck(this)" method="post">{% csrf_token %}
        <div class="row">
            <div class="col-lg-3">
                <select name="action" class="form-control">
                    <option value="">------------------</option>
                    {% for action in admin_class.actions %}
                    <option value="{{ action }}">{{ action }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                 <input type="submit" value="GO">
            </div>
        </div>

        </form>

        <table class="table table-striped">
            <thead>
            <tr>
                {% if admin_class.list_display %}
                    <th><input type="checkbox" onclick="SelectAllObjs(this)"></th>
                    {% for column in admin_class.list_display %}
                        <th>
                            <a
                                    href="?_o={% get_sorted_column column sorted_column forloop.counter0 %}{% render_filtered_args admin_class %}"
                            >
                                {{ column }}
                                {% render_sorted_arrow column sorted_column %}
                            </a>
                        </th>

                    {% endfor %}
                {% else %}
                    {#<th>{{ admin_class.model._meta.model_name }}</th> 不能以_开头#}
                    <th>{% get_model_name admin_class %}</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            <br>
            {% for obj in querysets %}
                <tr>
                    <td><input row-select="true" type="checkbox" value="{{ obj.id }}"></td>
                    {% build_table_row obj admin_class %}
                </tr>
            {% endfor %}
            </tbody>
        </table>


        <div class="pagination">


            {% render_paginator querysets admin_class sorted_column %}


            {#        <span class="step-links">#}
            {#            {% if querysets.has_previous %}#}
            {#                <a href="?_page={{ querysets.previons_page_number }}">previous</a>#}
            {#            {% endif %}#}
            {#            <span class="current">#}
            {#            Page    {{ querysets.number }} of {{ querysets.paginator.num_pages }}#}
            {#            </span>#}
            {#            {% if querysets.has_next %}#}
            {#                <a href="?_page={{ querysets.next_page_number }}">next</a>#}
            {#            {% endif %}#}
            {##}
            {#        </span>#}
            {#    </div>#}

        </div>
    </div>

    <script>
    function SelectAllObjs(ele) {
        if ($(ele).prop('checked')){
            $('input[row-select]').prop('checked',true);

        }else{
            $('input[row-select]').prop('checked',false);
        }
    }

    function ActionCheck(ele) {
        var selected_action = $('select[name="action"]').val();
        var selected_objs = $('input[row-select]').filter(':checked');
        if (selected_action.length === 0) {
            alert('no action selected!');
            return false
        }
        if (selected_objs.length === 0) {
            alert('no action selected!');
            return false
        } else {
            //生成一个标签，放到form中
            var selected_ids = [];
            $.each(selected_objs, function () {
                //console.log($(this))
                selected_ids.push($(this).val());

            });
            //console.log(selected_ids)
            var ele_input = '<input type="hidden" name="selected_ids" value' +'=' +JSON.stringify(selected_ids) + ">";
            //<input type="hidden" name="selected_ids" value=
            $(ele).append(ele_input);
        }

    }

    </script>

{% endblock right-content-container %}

```

###### 2）后端

crm/admin.py

```python
from django.contrib import admin
from crm.models import *


# Register your models here.
class CustomerAdmin(admin.ModelAdmin):
    list_display = ['id', 'name', 'contact', 'contact_type', 'source', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    # list_per_page = 2
    # readonly_fields = ['contact','status']
    filter_horizontal = ['consult_courses']
    actions = ['change_status', ]

    def change_status(self, request, querysets):
        # print('admin action', self, request, querysets)
        querysets.update(status=1)


class CourseRecordAdmin(admin.ModelAdmin):
    list_display = ['class_grade', 'day_num', 'has_homework']
    list_editable = ['has_homework']


admin.site.register(UserProfile)
admin.site.register(Role)
admin.site.register(CustomerInfo, CustomerAdmin)
admin.site.register(Student)
admin.site.register(CustomerFollowUp)
admin.site.register(Course)
admin.site.register(ClassList)
admin.site.register(CourseRecord, CourseRecordAdmin)
admin.site.register(StudyRecord)
admin.site.register(Branch)
admin.site.register(Menus)

```

useradmin/admin_base.py

```python
from django.shortcuts import render


class BaseUserAdmin(object):
    def __init__(self):
        self.actions.extend(self.default_actions)

    list_display = []
    list_filter = []
    search_fields = []
    readonly_fields = []
    filter_horizontal = []
    list_per_page = 20
    default_actions = ['delete_selected_objs']
    actions = []

    def delete_selected_objs(self, request, querysets):
        return render(request, 'useradmin/table_obj_delete.html')

```

crm/useradmin.py

```python

from useradmin.sites import site
from useradmin.admin_base import BaseUserAdmin

from crm import models


# print('crm useradmin ...')


class CustomerAdmin(BaseUserAdmin):
    list_display = ['id', 'name', 'source', 'contact_type', 'contact', 'consultant', 'consult_content', 'status',
                    'date']  # 显示字段
    list_filter = ['source', 'consultant', 'status', 'date']  # 过滤字段
    # search_fields = ['name', 'contact', 'consultant']  # 可搜索字段，由于有外键关联的字段，所以必须写明是外键的哪个字段
    search_fields = ['name', 'contact', 'consultant__name']
    readonly_fields = ['contact', 'status']  # 只读，不可修改字段
    filter_horizontal = ['consult_courses']
    # list_per_page = 5
    actions = ['change_status', ]

    def change_status(self, request, querysets):
        # print('admin action', self, request, querysets)
        # print('----------',self,request,querysets)
        querysets.update(status=0)



site.register(models.CustomerInfo, CustomerAdmin)
site.register(models.Role)
site.register(models.Menus)
site.register(models.Course)
site.register(models.ClassList)
site.register(models.CourseRecord)
site.register(models.StudyRecord)
site.register(models.UserProfile)

```

useradmin/views.py

```python
@login_required
def table_obj_list(request, app_name, model_name):
    """取出指定的model里的数据返回给前端"""
    # print('app_name,model_name:',site.enabled_admins[app_name][model_name])
    admin_class = site.enabled_admins[app_name][model_name]
    # print(request.GET)
    # 打印结果：<QueryDict: {'source': ['1'], 'consultant': ['2'], 'status': ['0'], 'date': ['2018-07-01 11:19:26.324492']}>
    # print('admin_class',admin_class.model)

    if request.method == 'POST':
        selected_action = request.POST.get('action')
        selected_ids = json.loads(request.POST.get('selected_ids'))
        # print(selected_action,selected_ids)
        selected_objs = admin_class.model.objects.filter(id__in=selected_ids)
        admin_action_func = getattr(admin_class,selected_action)
        admin_action_func(request,selected_objs)
...
```

#### 3、批量删除

useradmin/views.py

```python
@login_required
def table_obj_list(request, app_name, model_name):
    """取出指定的model里的数据返回给前端"""
    # print('app_name,model_name:',site.enabled_admins[app_name][model_name])
    admin_class = site.enabled_admins[app_name][model_name]
    # print(request.GET)
    # 打印结果：<QueryDict: {'source': ['1'], 'consultant': ['2'], 'status': ['0'], 'date': ['2018-07-01 11:19:26.324492']}>
    # print('admin_class',admin_class.model)

    if request.method == 'POST':
        selected_action = request.POST.get('action')
        selected_ids = json.loads(request.POST.get('selected_ids'))
        # print(selected_action,selected_ids)
        if not selected_action:
            # 如果有action参数，代表正常action 没有代表可能是一个删除动作
            if selected_ids:# 这些选中的数据都要被删除
                admin_class.model.objects.filter(id__in=selected_ids).delete()
        else:
            selected_objs = admin_class.model.objects.filter(id__in=selected_ids)
            admin_action_func = getattr(admin_class,selected_action)
            response = admin_action_func(request,selected_objs)
            if response:
                return response

    querysets = admin_class.model.objects.order_by('-id')
    # querysets = admin_class.model.objects.all()
    # filter_conditions中有筛选条件，赋值给admin_class
    querysets, filter_conditions = get_filter_result(request, querysets)
    admin_class.filter_conditions = filter_conditions

    # search queryset result
    querysets = get_search_result(request, querysets, admin_class)
    admin_class.search_key = request.GET.get('_q', '')

    # sorted_querysets
    # print(querysets)
    querysets, sorted_column = get_orderby_result(request, querysets, admin_class)

    paginator = Paginator(querysets, admin_class.list_per_page)  # 获取对象，每页几个
    page = request.GET.get('_page')
    try:
        querysets = paginator.page(page)
    except PageNotAnInteger:
        querysets = paginator.page(1)
    except EmptyPage:
        querysets = paginator.page(paginator.num_pages)

    return render(request, 'useradmin/table_obj_list.html',
                  {'querysets': querysets, 'admin_class': admin_class, 'sorted_column': sorted_column})
```

table_obj_delete.html

```html
{% extends 'useradmin/index.html' %}
{% load useradmin_tags %}
{% block right-content-container %}

    <h3 class="page-header">{% get_model_name admin_class %}</h3>
    <h4 class="page-header">注意：以下{% if obj %}与{{ obj }}{% endif %}相关的数据都将被删除</h4>
    <div>
    {% if objs %}
        {% for obj in objs %}
            {% display_all_related_objs obj as  all_related_obj_ele %}
            {{ all_related_obj_ele |safe }}
        {% endfor %}
    {% else %}
        {% display_all_related_objs obj as  all_related_obj_ele %}
        {{ all_related_obj_ele |safe }}
    {% endif %}
        <form method="post">{% csrf_token %}
            {% if querysets_ids %}
                <input type="hidden" name="selected_ids" value="{{ querysets_ids }}">
            {% endif %}

            <input type="submit" class="btn btn-danger" value="确认删除">
            <a class="btn btn-info" href="/useradmin/{{app_name}}/{{ model_name }}/{{ obj_id }}/change">返回</a>
        </form>


    </div>
{% endblock right-content-container %}
```



