根目录下新建fortress_manager.py和backend （python package）

fortress_manager.py

```python
import sys


if __name__ == "__main__":
    from backend import main
    interactive_obj = main.ArgvHandler(sys.argv)
    interactive_obj.call()
```

main.py

```python
class ArgvHandler(object):
    """接收用户参数，并调用相应的功能"""

    def __init__(self, sys_args):
        self.sys_args = sys_args

    def help_msg(self,error_msg=''):
        """打印帮助"""
        msg = """
        %s
        run  启动用户交互程序
        
        """%error_msg

        exit(msg)

    def call(self):
        """根据用户参数，调用对应的方法"""
        if len(self.sys_args) == 1:
            self.help_msg()
        if hasattr(self, self.sys_args[1]):
            func = getattr(self, self.sys_args[1])
            func()
        else:
            self.help_msg("没有方法：%s"%self.sys_args[1])

    def run(self):
        """启动用户交互程序"""

        from backend.ssh_interactive import SSHHandler
        obj = SSHHandler(self)
        obj.interactive()

```

ssh_interactive.py

```python
from django.contrib.auth import authenticate


class SSHHandler(object):
    """堡垒机交互脚本"""

    def __init__(self, argv_handlere_instance):
        self.argv_handlere_instance = argv_handlere_instance

    def auth(self):
        """认证程序"""
        count = 0
        while count < 3:
            username = input('堡垒机账号:').strip()
            password = input('密码:').strip()
            user = authenticate(username=username, password=password)
            if user:
                self.user = user
                return True
            else:
                count += 1

    def interactive(self):
        """启动交互脚本"""
        if self.auth():
            print('Ready to print all the authorized hosts... to this user')
```

控制台输入：python fortress_manager.py run

此时报错：

​	原因是不在django的环境中去调用了django的数据库

```
django.core.exceptions.ImproperlyConfigured: Requested setting AUTHENTICATION_BACKENDS, but settings are not configured. You must either
define the environment variable DJANGO_SETTINGS_MODULE or call settings.configure() before accessing settings.
```

配置环境变量

fortress_manager.py

```python
if __name__ == "__main__":
    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "fortress.settings") # 设置环境变量
```

再次执行，报错，没有加载django的app

```python
django.core.exceptions.AppRegistryNotReady: Apps aren't loaded yet.
```

fortress_manager.py

```python
if __name__ == "__main__":
    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "fortress.settings") # 设置环境变量
    import django
    django.setup()
```

再去执行，输入用户名密码就ok了





打印用户组：

​	添加数据

​		...

​	ssh_interactive.py

```python
"""
@Author: sen
@Date  : 2018/8/10 15:43
@Software  : PyCharm
@File    : ssh_interactive.py
@Purpose   :交互
"""
from django.contrib.auth import authenticate


class SSHHandler(object):
    """堡垒机交互脚本"""

    def __init__(self, argv_handlere_instance):
        self.argv_handlere_instance = argv_handlere_instance

    def auth(self):
        """认证程序"""
        count = 0
        while count < 3:
            username = input('堡垒机账号:').strip()
            password = input('密码:').strip()
            user = authenticate(username=username, password=password)
            if user:
                self.user = user
                return True
            else:
                count += 1
                if count != 3:
                    print('密码错误，您还有%s次机会' % (3 - count))
                else:
                    print('对不起，密码输入超过限制,如需登录，重新运行')

    def interactive(self):
        """启动交互脚本"""
        if self.auth():
            print('Ready to print all the authorized hosts... to this user...')

            while True:

                host_groups_list = self.user.host_groups.all()
                for index,host_group_obj in enumerate(host_groups_list):
                    print('%s.\t%s[%s]'%(index,host_group_obj.name,host_group_obj.host_to_remote_users.count()))
                print('z.\t未分组主机[%s]' % (self.user.host_to_remote_users.count()))

                choice = input("请选择主机组>>:").strip()
                if choice.isdigit():
                    choice = int(choice)
                    selected_host_group = host_groups_list[choice]
                    while True:
                        for index,host_to_user_obj in enumerate(selected_host_group.host_to_remote_users.all()):
                            print('%s.\t%s' % (index, host_to_user_obj))

                        choice = input("请选择主机>>:").strip()
                        if choice.isdigit():
                            choice = int(choice)
                            selected_host_to_user_obj = selected_host_group.host_to_remote_users.all()[choice]
                            print('going to logon %s'%(selected_host_to_user_obj))
                elif choice == 'z':
                    for index, host_to_user_obj in enumerate(self.user.host_to_remote_users.all()):
                        print('%s.\t%s' % (index, host_to_user_obj))


```

优化上面代码

```python
def interactive(self):
    """启动交互脚本"""
    if self.auth():
        print('Ready to print all the authorized hosts... to this user...')

        while True:
            selected_host_group = ''
            host_groups_list = self.user.host_groups.all()
            for index,host_group_obj in enumerate(host_groups_list):
                print('%s.\t%s[%s]'%(index,host_group_obj.name,host_group_obj.host_to_remote_users.count()))
                print('z.\t未分组主机[%s]' % (self.user.host_to_remote_users.count()))


                choice = input("请选择主机组>>:").strip()
                if choice.isdigit():
                    choice = int(choice)
                    selected_host_group = host_groups_list[choice]
                    elif choice == 'z':
                        selected_host_group =self.user


                        while True:
                            for index,host_to_user_obj in enumerate(selected_host_group.host_to_remote_users.all()):
                                print('%s.\t%s' % (index, host_to_user_obj))
                                print('b.\t返回上一层')
                                choice = input("请选择主机>>:").strip()

                                if choice.isdigit():
                                    choice = int(choice)
                                    selected_host_to_user_obj = selected_host_group.host_to_remote_users.all()[choice]
                                    print('going to logon %s'%(selected_host_to_user_obj))
                                    if choice == 'b':
                                        break
```

