### zookeeper

分布式协同管理服务、提供通用的分布式锁服务，用以协调分布式应用

##### 成员

![zookeeper的角色](./img/zookeeper%E7%9A%84%E8%A7%92%E8%89%B2.png)



领导者(leader)：     负责进行投票的发起和决议，更新系统状态。

跟随者(Follower)： 用于接受客户端请求并想客户端返回结果，在选主过程中参与投票。



由于Zookeeper需保证高可用和强一致性；为了支持更多的客户端，需要增加更多Server；

但Server增多，会增加投票阶段的延迟，影响性能。



观察者(Observer)：可以接受客户端连接，将写请求转发给leader，但不参于投票

​				   目的是为了扩展系统，提高读取速度，并且不影响吞吐率   (但一般不使用Observer)

客户端(Client)：发起请求

##### 特点

| 特点         | 说明                                                         |
| :----------- | :----------------------------------------------------------- |
| 最终一致性   | 为客户端展示同一个视图；每台服务器中的数据是一致的           |
| 可靠性       | 每台服务器的 数据是强一致性的；每台服务器又构成一个整体可靠的集群 |
| 实时性(java) | Zookeeper不能保证两个客户端能同时得到刚更新的数据，如果需要就要调用sync()接口 |
| 独立性       | 每个客户端之前互不影响                                       |
| 原子性       | 更新的状态只有成功或者失败                                   |
| 顺序性       | 所有Server，同一消息发布顺序一致。                           |

##### 工作原理

1.每个Server在内存中存储了一份数据；

2.Zookeeper启动时，将从实例中选举一个leader（Paxos协议）

3.Leader负责处理数据更新等操作	

4.一个更新操作成功，当且仅当大多数Server在内存中成功修改数据。

Zookeeper的核心是 原子广播，这个机制保证了各个server之间的同步。实现这个机制的协议叫做 Zab 协议。
	Zab协议有两种模式，它们分别是恢复模式和广播模式。

​	当服务启动或者在领导者崩溃后，Zab就进入了 恢复模式，当领导者被选举出来，

​	且大多数server的完成了和leader的状态同步以后，恢复模式就结束了。状态同

​	步保证了leader和server具有相同的系统状态。一旦leader已经和多数的follower

​	进行了状态同步后，他就可以开始广播消息了，即进入 广播状态。这时候当一个

​	server加入zookeeper服务中，它会在恢复模式下启动，发现leader，并和leader

​	进行状态同步。待到同步结束，它也参与消息广播。

##### znode节点

Znode有两种类型， 短暂的（ ephemeral ）和持久的（persistent）

​	Znode的类型在创建时确定并且之后不能再修改

​	短暂znode的客户端会话结束时，zookeeper会将该短暂znode删
	除， 短暂 znode 不可以有子节点

​	持久znode不依赖于客户端会话，只有当客户端明确要删除该持
	久znode时才会被删除（父节点一定是持久的）

​	Znode有四种形式的目录节点
		PERSISTENT、持久的
		EPHEMERAL、短暂的
		PERSISTENT_SEQUENTIAL持久且有序的
		EPHEMERAL_SEQUENTIAL 短暂且有序的

